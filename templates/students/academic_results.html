{% extends "base/base.html" %}

{% block title %}Academic Results{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Academic Results: {{ student.get_full_name }}</h2>
            <p class="mb-1">Registration Number: <strong>{{ student.registration_number }}</strong></p>
            <p class="mb-0">Programme: <strong>{{ student.programme.name }}</strong></p>
        </div>
        <div>
            <button class="btn btn-secondary me-2" id="expandAllBtn">Expand All</button>
            <button class="btn btn-primary" id="generateTranscriptBtn">Generate Transcript</button>
        </div>
    </div>

    {% if results_by_year %}
    <ul class="nav nav-tabs mb-3" id="yearTab" role="tablist">
        {% for year_name, year_data in results_by_year.items %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if forloop.first %}active{% endif %}" id="tab-{{ forloop.counter }}-tab" data-bs-toggle="tab"
                data-bs-target="#tab-{{ forloop.counter }}" type="button" role="tab" aria-controls="tab-{{ forloop.counter }}"
                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                {{ year_name }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <div class="tab-content" id="yearTabContent">
        {% for year_name, year_data in results_by_year.items %}
        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="tab-{{ forloop.counter }}" role="tabpanel"
            aria-labelledby="tab-{{ forloop.counter }}-tab">

            {% for semester_number, semester_data in year_data.semesters.items %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Semester {{ semester_number }}</h5>
                    <button class="btn btn-sm btn-outline-primary toggleSemesterBtn" data-bs-toggle="collapse"
                        data-bs-target="#collapse-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                        Toggle
                    </button>
                </div>
                <div id="collapse-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="collapse show">
                    <div class="card-body">
                        {% if semester_data.units %}
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Unit Code</th>
                                        <th>Unit Name</th>
                                        <th>CAT</th>
                                        <th>Exam</th>
                                        <th>Total Score</th>
                                        <th>Grade</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for unit in semester_data.units %}
                                    <tr>
                                        <td>{{ unit.unit_code }}</td>
                                        <td>{{ unit.unit_name }}</td>
                                        <td>
                                            {% if unit.cat_score == 0 %}
                                            N/A
                                            {% else %}
                                            {{ unit.cat_score }}
                                            {% endif %}
                                        </td>
                                        <td>{{ unit.exam_score }}</td>
                                        <td>{{ unit.total_score }}</td>
                                        <td>{{ unit.grade }}</td>
                                        <td>
                                            {% if unit.exam_score %}
                                                {% if unit.is_pass %}
                                                    <span class="badge bg-success">Pass</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Fail</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary">N/A</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info mb-0">
                            No results available for Semester {{ semester_number }}.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}

        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-warning">
        No academic results available. If you believe this is an error, please contact the academic office.
    </div>
    {% endif %}
</div>

<script>
    document.getElementById("expandAllBtn").addEventListener("click", function () {
        const collapses = document.querySelectorAll('.collapse');
        collapses.forEach(c => new bootstrap.Collapse(c, { show: true }));
    });

    document.getElementById("generateTranscriptBtn").addEventListener("click", function () {
        alert("Transcript generation not implemented.");
    });
</script>
{% endblock %}
